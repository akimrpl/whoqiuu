<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home - Who Qiuuu??</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', sans-serif;
      display: flex; flex-direction: column;
    }
    header {
      background: #075E54; color: white; padding: 15px; text-align: center; font-weight: bold;
      position: fixed; width: 100%; top: 0; z-index: 10;
    }
    .container {
      display: flex; flex: 1; height: 100%;
    }
    .friends-list {
      flex: 1; overflow-y: auto; background: white; margin-top: 60px;
    }
    .friend {
      padding: 15px; border-bottom: 1px solid #ddd; cursor: pointer;
      display: flex; align-items: center;
    }
    .friend:hover {
      background: #f5f5f5;
    }
    .friend img {
      width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;
      object-fit: cover;
    }
    .friend .name {
      font-weight: bold;
    }
    .chat-window {
      flex: 2; display: none; flex-direction: column; padding: 20px; background-color: #ece5dd;
    }
    .bubble {
      max-width: 70%; padding: 10px; margin: 5px 0; border-radius: 10px;
      word-wrap: break-word; position: relative;
    }
    .bubble.me {
      align-self: flex-end; background-color: #dcf8c6;
    }
    .bubble.other {
      align-self: flex-start; background-color: white; border: 1px solid #ddd;
    }
    #input-area {
      display: flex; padding: 10px; background-color: #f0f0f0;
    }
    #messageInput {
      flex: 1; padding: 10px; font-size: 16px; border: none; border-radius: 20px;
      margin-right: 10px; outline: none;
    }
    #sendBtn {
      background-color: #075E54; color: white; border: none; padding: 10px 15px;
      border-radius: 20px; font-size: 16px; cursor: pointer;
    }
    .back-btn {
      background: #075E54; color: white; border: none; padding: 10px 15px;
      border-radius: 5px; cursor: pointer; margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <header>Who Qiuuu??</header>
  <div class="container">
    <!-- Daftar Teman -->
    <div class="friends-list" id="friends-list"></div>

    <!-- Jendela Chat -->
    <div class="chat-window" id="chat-window">
      <button class="back-btn" id="back-btn">&larr; Back</button>
      <div id="chat-header"></div>
      <div id="chat-messages"></div>
      <div id="input-area">
        <input id="messageInput" placeholder="Ketik pesan..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB-2-57pQg7imMuRJ3-IXcNCCqmVK_UlvE",
      authDomain: "websitechatting-27a3a.firebaseapp.com",
      databaseURL: "https://websitechatting-27a3a-default-rtdb.firebaseio.com",
      projectId: "websitechatting-27a3a",
      storageBucket: "websitechatting-27a3a.firebasestorage.app",
      messagingSenderId: "129560953968",
      appId: "1:129560953968:web:0420733e3f88d41044a0b5"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let currentChatId = null;
    const friendsListDiv = document.getElementById('friends-list');
    const chatWindowDiv = document.getElementById('chat-window');
    const chatMessagesDiv = document.getElementById('chat-messages');
    const chatHeader = document.getElementById('chat-header');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const backBtn = document.getElementById('back-btn');

    // Menangani perubahan status autentikasi
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      loadFriends();  // Load daftar teman
    });

    // Memuat daftar teman
    function loadFriends() {
      db.ref('users').once('value').then(snapshot => {
        const users = snapshot.val() || {};
        friendsListDiv.innerHTML = '';
        Object.entries(users).forEach(([uid, userData]) => {
          if (uid === currentUser.uid) return; // Jangan tampilkan diri sendiri
          const friendDiv = document.createElement('div');
          friendDiv.className = 'friend';
          friendDiv.innerHTML = `
            <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="User" />
            <div class="name">${userData.name || 'No Name'}</div>
          `;
          friendDiv.onclick = () => startChat(uid, userData.name);
          friendsListDiv.appendChild(friendDiv);
        });
      });
    }

    // Memulai chat dengan teman
    function startChat(friendUid, friendName) {
      currentChatId = getChatId(currentUser.uid, friendUid);
      chatHeader.innerHTML = `Chat with ${friendName}`;
      friendsListDiv.style.display = 'none';  // Sembunyikan daftar teman
      chatWindowDiv.style.display = 'flex';   // Tampilkan jendela chat
      loadMessages();
    }

    // Mengambil ID chat unik antara dua user
    function getChatId(uid1, uid2) {
      return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
    }

    // Memuat pesan chat
    function loadMessages() {
      const messagesRef = db.ref(`chats/${currentChatId}`);
      messagesRef.on('child_added', snapshot => {
        const msg = snapshot.val();
        const bubble = document.createElement('div');
        bubble.className = msg.sender === currentUser.uid ? 'bubble me' : 'bubble other';
        bubble.textContent = msg.text;
        chatMessagesDiv.appendChild(bubble);
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      });
    }

    // Kirim pesan
    sendBtn.onclick = function() {
      const message = messageInput.value;
      if (message.trim()) {
        const messagesRef = db.ref(`chats/${currentChatId}`);
        messagesRef.push().set({
          sender: currentUser.uid,
          text: message,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        messageInput.value = '';
      }
    };

    // Tombol back untuk kembali ke daftar teman
    backBtn.onclick = function() {
      friendsListDiv.style.display = 'block';  // Kembali ke daftar teman
      chatWindowDiv.style.display = 'none';    // Sembunyikan jendela chat
    };
  </script>
</body>
</html>
